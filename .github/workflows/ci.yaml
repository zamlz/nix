name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  check:
    name: Check & Build
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v5

    - name: Install Nix
      uses: cachix/install-nix-action@v31
      with:
        extra_nix_config: |
          experimental-features = nix-command flakes

    # Setup Cachix binary cache for faster builds
    - name: Setup Cachix
      uses: cachix/cachix-action@v15
      with:
        # Uses the public nix-community cache to avoid rebuilding common packages
        name: nix-community
        authToken: '${{ secrets.CACHIX_AUTH_TOKEN }}'

    - name: Run all checks for flake.nix
      run: nix flake check -v

    - name: Check Nix flake health
      uses: DeterminateSystems/flake-checker-action@main

    # FIXME: nix build fails in the CI pipeline for some reason
    # Builds the complete home-manager configuration into an activation package
    # This compiles all configurations and dependencies to ensure everything works
    # - name: Build configuration
    #   run: nix build
